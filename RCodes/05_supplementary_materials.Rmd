---
title: "Exploration of Neighborhood Racial Composition, Built Environment and Health Outcomes"
output: html_document
---

```{r message=FALSE}
library(sf)
library(tidyr)
library(tidyverse)
library(dplyr)
library(corrplot)
library(ggcorrplot)
library(reshape2)   
library(car)
library(reshape)
library(knitr)
library(stringr)
library(effects)
library(corrplot)
library(vtable)
library(ggplot2)
library(ggridges)

knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir ='/Users/ahyoungcho/Dropbox/CAR/2022 Summer/')

# Load data 
df <- readRDS(file = "/Users/ahyoungcho/Dropbox/CAR/2022 Summer/Replication/FinalData/finaldata.rds")
```

```{r, warning=FALSE, message = FALSE}
df$log.median.house.income  <- log(df$Median.household.income)
```

### Table S1: Descriptive statistics of health outcomes, built environment indicators, and census tract level covariates used in the model including all urban and rural areas.
```{r table s1}
df_analysis <- df %>% 
  dplyr::select(sleep_crud, diabetes_c, casthma_cr, prop_dilapbldg, prop_2ormorecars, prop_chainlink, prop_letters, prop_streetlight, prop_green, prop_crosswalk, prop_not_single_family_home, prop_single_lane, prop_visible_wire, prop_sidewalk, Hispanic, Asian, Black, White, Median.household.income, Pct_college, Age, Pct_Female, Pct_insurance, Pct_Owner, Pct_Vacant, Pct_SingleFam, Urban_Rural_New) %>%
  filter(Urban_Rural_New != 99)

var.labs <- data.frame(var = c("sleep_crud", "diabetes_c", "casthma_cr", "prop_dilapbldg", "prop_2ormorecars", "prop_chainlink", "prop_letters", "prop_streetlight", "prop_green", "prop_crosswalk", "prop_not_single_family_home", "prop_single_lane", "prop_visible_wire", "prop_sidewalk", "Hispanic", "Asian", "Black", "White", "Median.household.income", "Pct_college", "Age", "Pct_Female", "Pct_insurance", "Pct_Owner", "Pct_Vacant", "Pct_SingleFam", "Urban_Rural_New"),
                       labels = c("Sleeping Problems", "Diabetes", "Asthma", "% Dilapidated", "% Two or More Cars", "% Chain Link", "% Street Signs", "% Street Lights", "% Green space", "% Crosswalk", "% Non-single Family Home", "% Single Lane", "% Visible Wire", "% Sidewalk", "Hispanic", "NH Asian", "NH Black", "NH White", "Median Household Income", "% College", "Age", "% Female", "% Insured", "% Owner Occupied Housing", "% Vacant Housing", "% Single Female Head of Household with Children", "Urbanity"))

st(df_analysis, 
   labels = var.labs,
   summ = c('notNA(x)','mean(x)','sd(x)'),
   summ.names = c('N','Mean','Std. Dev'),
   title = "Descriptive statistics of health outcomes, built environment indicators, and census tract level covariates used in the model",
   out = "html",
   file = "/Users/ahyoungcho/Dropbox/CAR/2022 Summer/Replication/Output/Supplementary/TableS1.html")

```

### Figure S2: Distribution of outcome variables. The top panels include all urban and rural areas.  The bottom two panels are categorized by urbanity. 
```{r figure s2}
library(RColorBrewer)

df_gsv <- df %>% 
  dplyr::select(tract2010, prop_dilapbldg, prop_green, prop_crosswalk, prop_not_single_family_home, prop_single_lane) 

melt_df_gsv <- melt(df_gsv)

gsvlabel = as_labeller(c(`prop_dilapbldg` = "% Dilapidated", 
                         `prop_green` = "% Green space", 
                         `prop_crosswalk` = "% Crosswalk", 
                         `prop_not_single_family_home` = "% Non-single Family Home", 
                         `prop_single_lane` = "% Single Lane"))

dist_gsv_prop_dilapbldg <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_dilapbldg"), 
                                      aes(x = value, fill = "#E0BBE4")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~variable, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#E0BBE4"), guide = "none") +
  ylim(0, 10) +
  theme_minimal()

dist_gsv_prop_green <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_green"), 
                                      aes(x = value, fill = "#957DAD")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~variable, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#957DAD"), guide = "none") +
  ylim(0, 10) +
  theme_minimal()

dist_gsv_prop_crosswalk <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_crosswalk"), 
                                      aes(x = value, fill = "#D291BC")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~variable, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#D291BC"), guide = "none") +
  ylim(0, 10) +
  theme_minimal()

dist_gsv_prop_not_single_family_home <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_not_single_family_home"), 
                                      aes(x = value, fill = "#FEC8D8")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~variable, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#FEC8D8"), guide = "none") +
  ylim(0, 5) +
  theme_minimal()

dist_gsv_prop_single_lane <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_single_lane"),
                                      aes(x = value, fill = "#FFDFD3")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~variable, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#FFDFD3"), guide = "none") +
  ylim(0, 5) +
  theme_minimal()

dist_final <- ggpubr::ggarrange(dist_gsv_prop_dilapbldg, dist_gsv_prop_green, dist_gsv_prop_crosswalk, dist_gsv_prop_not_single_family_home, dist_gsv_prop_single_lane, nrow = 3, ncol = 2)


df_gsv <- df %>% 
  mutate(Urban_Rural_New = factor(Urban_Rural_New)) %>%
  dplyr::select(Urban_Rural_New, prop_dilapbldg, prop_green, prop_crosswalk, prop_not_single_family_home, prop_single_lane) 


melt_df_gsv <- melt(df_gsv) %>%
  filter(Urban_Rural_New != "NA")

gsvlabel = as_labeller(c(`prop_dilapbldg` = "% Dilapidated", 
                         `prop_green` = "% Green space", 
                         `prop_crosswalk` = "% Crosswalk", 
                         `prop_not_single_family_home` = "% Non-single Family Home", 
                         `prop_single_lane` = "% Single Lane",
                         `1` = "Urban 1", 
                         `2` = "Urban 2",
                         `3` = "Urban 3",
                         `4` = "Urban 4"))

dist_gsv_prop_dilapbldg_urb <- ggplot(data = melt_df_gsv%>% filter(variable == "prop_dilapbldg"), 
                                      aes(x = value, fill = "#E0BBE4")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~Urban_Rural_New, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#E0BBE4"), guide = "none") +
  ylim(0, 10) +
  theme_minimal()

dist_gsv_prop_green_urb <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_green"),
                                      aes(x = value, fill = "#957DAD")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~Urban_Rural_New, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#957DAD"), guide = "none") +
  ylim(0, 10) +
  theme_minimal()

dist_gsv_prop_crosswalk_urb <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_crosswalk"),
                                      aes(x = value, fill = "#D291BC")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~Urban_Rural_New, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#D291BC"), guide = "none") +
  ylim(0, 30) +
  theme_minimal()

dist_gsv_prop_not_single_family_home_urb <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_not_single_family_home"), 
                                      aes(x = value, fill = "#FEC8D8")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~Urban_Rural_New, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#FEC8D8"), guide = "none") +
  ylim(0, 5) +
  theme_minimal()
  
dist_gsv_prop_single_lane_urb <- ggplot(data = melt_df_gsv %>% filter(variable == "prop_single_lane"),
                                      aes(x = value, fill = "#FFDFD3")) + 
  geom_histogram(aes(y = ..density..)) + 
  facet_wrap(~Urban_Rural_New, labeller = gsvlabel) +
  xlab("") + ylab("Percentage") +
  scale_fill_manual(values=c("#FFDFD3"), guide = "none") +
  ylim(0, 5) +
  theme_minimal()

a <- ggpubr::ggarrange(dist_gsv_prop_dilapbldg, dist_gsv_prop_green, dist_gsv_prop_crosswalk, dist_gsv_prop_not_single_family_home, dist_gsv_prop_single_lane,
                  dist_gsv_prop_dilapbldg_urb, dist_gsv_prop_green_urb, dist_gsv_prop_crosswalk_urb, dist_gsv_prop_not_single_family_home_urb, dist_gsv_prop_single_lane_urb,
                  ncol = 5, nrow = 2)

jpeg(file = "/Users/ahyoungcho/Dropbox/CAR/2022 Summer/Replication/Output/Supplementary/FigureS2.jpeg", width = 20, height = 12, res = 300, units = 'in')
a
dev.off()
```

### Figure S3: Correlation Heatmap.
```{r figure s3}
# Create correlation plots
df_corr <- df %>%
  dplyr::select(-tract2010, -GEOID, -Census, -County, -State) %>%
  dplyr::select(prop_dilapbldg, prop_green, 
                prop_crosswalk, prop_not_single_family_home, prop_single_lane, 
                White, Black, Asian, Hispanic,
                Median.household.income, Pct_college, Age, Pct_Female, 
                Pct_insurance, Pct_Owner, Pct_Vacant, Pct_SingleFam, Urban_Rural_New) %>%
  mutate(Urban_Rural_New = as.numeric(Urban_Rural_New)) %>%
  na.omit()

corr <- round(cor(df_corr), 2)
p.mat <- cor_pmat(df_corr)

corr.plot <- ggcorrplot(corr = corr , 
                          p.mat = p.mat,
                          show.diag = T,
                          lab = T,
                          lab_size = 4, 
                          type = "lower",
                          outline.color = "white",
                          insig = "blank",
                          ggtheme = ggplot2::theme_minimal,
                          legend.title = "Correlation") +
  theme(axis.text = element_text(size = 7)) +
  scale_x_discrete(labels = c("% Dilapidated", "% Green space", "% Crosswalk",
                              "% Non-single family home", "% Single lane",
                              "% White", "% Black", "% Asian", "% Hispanic",
                              "Median Income", "% College", "Age", "% Female", 
                              "% Insured", "% Owner", "% Vacant", "% Single Family", "% Urbanity")) +
  scale_y_discrete(labels = c("% Dilapidated", "% Green space", "% Crosswalk",
                              "% Non-single family home", "% Single lane",
                              "% White", "% Black", "% Asian", "% Hispanic",
                              "Median Income", "% College", "Age", "% Female", 
                              "% Insured", "% Owner", "% Vacant", "% Single Family", "% Urbanity"))

corr.plot

jpeg(file = "/Users/ahyoungcho/Dropbox/CAR/2022 Summer/Replication/Output/Supplementary/FigureS3.jpeg", width = 14, height =11, res = 300, units = 'in')
corr.plot
dev.off()
```

### Table S2: Hierarchical Linear Model (HLM) regression with state fixed-effects for all urban and rural areas.

```{r, message=FALSE, warning=FALSE, include=FALSE}
df_composition <- df %>%
  mutate(Composition = ifelse(White >= 60 & Black < 20 & Hispanic < 20 & Asian < 20 & Native < 20 & HIPI < 20, "PW",
                       ifelse(Black >= 50 & White < 20 & Hispanic < 20 & Asian < 20 & Native < 20 & HIPI < 20, "PB",
                        ifelse(Black < 20 & White < 20 & (Asian >= 50 | Hispanic >= 50 | Native >= 50 | HIPI >= 50), "PNB", "Mixed"))))  %>%
  mutate(Composition = factor(Composition),
         bi_PW = ifelse(Composition == "PW", 1, 0),
         bi_PB = ifelse(Composition == "PB", 1, 0),
         bi_PNB = ifelse(Composition == "PNB", 1, 0),
         bi_mixed = ifelse(Composition == "Mixed", 1, 0)) %>%
  mutate(Pct_college = Pct_college / 100,
  Pct_Female = Pct_Female / 100,
  Pct_insurance = Pct_insurance / 100,
  Pct_Owner = Pct_Owner / 100, 
  Pct_Vacant = Pct_Vacant / 100,
  Pct_SingleFam = Pct_SingleFam /100,
  Urban_Rural_New = as.numeric(Urban_Rural_New))

df_composition$Composition <- relevel(df_composition$Composition, "PW")

### Dilapidated Building 
df_prop_dilapbldg <- df_composition %>%
  dplyr::select(prop_dilapbldg, Composition, Median.household.income, Pct_college , Age, Pct_Female , Pct_insurance , Pct_Owner , Pct_Vacant , Pct_SingleFam , Urban_Rural_New, State) %>%
  na.omit()

mod_na_fe1 <- lmer(prop_dilapbldg ~ Composition + (1|State),
                   data = df_prop_dilapbldg)

mod_na_cov_fe1 <- lmer(prop_dilapbldg ~ Composition + log(Median.household.income) + Pct_college + Age + Pct_Female + Pct_insurance + Pct_Owner + Pct_Vacant + Pct_SingleFam + Urban_Rural_New+ (1|State),
                       data = df_prop_dilapbldg)


### Green Space
df_prop_green <- df_composition %>%
  dplyr::select(prop_green, Composition, Median.household.income, Pct_college , Age, Pct_Female , Pct_insurance , Pct_Owner , Pct_Vacant , Pct_SingleFam , Urban_Rural_New, State) %>%
  na.omit()

mod_na_fe2 <- lmer(prop_green ~ Composition +(1| State),
                   data = df_prop_green)

mod_na_cov_fe2 <- lmer(prop_green ~ Composition + log(Median.household.income) + Pct_college + Age + Pct_Female + Pct_insurance + Pct_Owner + Pct_Vacant + Pct_SingleFam + Urban_Rural_New+(1| State),
                       data = df_prop_green)

### Crosswalk
df_prop_crosswalk <- df_composition %>%
  dplyr::select(prop_crosswalk, Composition, Median.household.income, Pct_college , Age, Pct_Female , Pct_insurance , Pct_Owner , Pct_Vacant , Pct_SingleFam , Urban_Rural_New, State) %>%
  na.omit()

mod_na_fe3 <- lmer(prop_crosswalk ~ Composition +(1| State),
                   data = df_prop_crosswalk)

mod_na_cov_fe3 <- lmer(prop_crosswalk ~ Composition + log(Median.household.income) + Pct_college + Age + Pct_Female + Pct_insurance + Pct_Owner + Pct_Vacant + Pct_SingleFam + Urban_Rural_New+(1| State),
                       data = df_prop_crosswalk)

### Not single family home 
df_prop_not_single_family_home <- df_composition %>%
  dplyr::select(prop_not_single_family_home, Composition, Median.household.income, Pct_college , Age, Pct_Female , Pct_insurance , Pct_Owner , Pct_Vacant , Pct_SingleFam , Urban_Rural_New, State) %>%
  na.omit()

mod_na_fe4 <- lmer(prop_not_single_family_home ~ Composition +(1| State),
                   data = df_prop_not_single_family_home)

mod_na_cov_fe4 <- lmer(prop_not_single_family_home ~ Composition + log(Median.household.income) + Pct_college + Age + Pct_Female + Pct_insurance + Pct_Owner + Pct_Vacant + Pct_SingleFam + Urban_Rural_New+(1| State),
                       data = df_prop_not_single_family_home)

### Single Lane 
df_prop_single_lane <- df_composition %>%
  dplyr::select(prop_single_lane, Composition, Median.household.income, Pct_college , Age, Pct_Female , Pct_insurance , Pct_Owner , Pct_Vacant , Pct_SingleFam , Urban_Rural_New, State) %>%
  na.omit()

mod_na_fe5 <- lmer(prop_single_lane ~ Composition +(1| State),
                   data = df_prop_single_lane)

mod_na_cov_fe5 <- lmer(prop_single_lane ~Composition + log(Median.household.income) + Pct_college + Age + Pct_Female + Pct_insurance + Pct_Owner + Pct_Vacant + Pct_SingleFam + Urban_Rural_New+(1| State),
                       data = df_prop_single_lane)

library(sjPlot) # table functions
library(sjmisc) # sample data

tab_model(mod_na_fe1, mod_na_cov_fe1, 
          mod_na_fe2, mod_na_cov_fe2, 
          mod_na_fe3, mod_na_cov_fe3, 
          mod_na_fe4, mod_na_cov_fe4, 
          mod_na_fe5, mod_na_cov_fe5, 
          show.se = TRUE,
          collapse.se = TRUE,
          col.order = c("est", "se"),
          show.ci = FALSE,
          p.style = "stars",
          dv.labels = c("% Dilapidated", "", "% Green Space", "",  "% Crosswalk", "",  "% Non-Single Family Home", "",  "% Single Lane", ""),
          pred.labels = c("Intercept",
                          "Racial Composition- Mixed",
                          "Racial Composition - PB",
                          "Racial Composition - PNBM",
                          "log(Household Income)",
                          "% College",
                          "Age",
                          "% Female",
                          "% Insured",
                          "% Owner",
                          "% Vacant",
                          "% Single Family",
                          "Urbanity"),
          CSS = list(
            modelcolumn1 = "background-color: #f0f0f0;", 
            modelcolumn3 = "background-color: #f0f0f0;", 
            modelcolumn5 = "background-color: #f0f0f0;"
  ),
  file = "/Users/ahyoungcho/Dropbox/CAR/2022 Summer/Replication/Output/Supplementary/TableS2.html"
)

```